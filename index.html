<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Cassa">
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="icon-cassa-180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-cassa-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-cassa-512.png">
    <title>Prima Nota Cassa</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { overscroll-behavior-y: contain; }
        input:focus, select:focus, textarea:focus { outline: none; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function App() {
            const [descrizioni, setDescrizioni] = useState([]);
            const [movimenti, setMovimenti] = useState([]);
            const [newMovimento, setNewMovimento] = useState({
                data: new Date().toISOString().split('T')[0],
                descrizione: '',
                importo: ''
            });
            const [filteredDescrizioni, setFilteredDescrizioni] = useState([]);
            const [showSuggestions, setShowSuggestions] = useState(false);
            const [loaded, setLoaded] = useState(false);
            const fileInputRef = useRef(null);
            const descrizioneInputRef = useRef(null);

            // Carica descrizioni salvate o mostra file picker
            useEffect(() => {
                const saved = localStorage.getItem('descrizioni');
                if (saved) {
                    setDescrizioni(JSON.parse(saved));
                    setLoaded(true);
                }
                
                const savedMovimenti = localStorage.getItem('movimenti');
                if (savedMovimenti) {
                    setMovimenti(JSON.parse(savedMovimenti));
                }
            }, []);

            // Salva movimenti in localStorage
            useEffect(() => {
                if (movimenti.length > 0) {
                    localStorage.setItem('movimenti', JSON.stringify(movimenti));
                } else {
                    localStorage.removeItem('movimenti');
                }
            }, [movimenti]);

            const loadExcelFile = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();

                reader.onload = (event) => {
                    const data = new Uint8Array(event.target.result);
                    const wb = XLSX.read(data, { type: 'array' });

                    // Carica descrizioni dal foglio "codici personali"
                    const codiciSheet = wb.Sheets['codici personali'];
                    if (!codiciSheet) {
                        alert('Foglio "codici personali" non trovato');
                        return;
                    }
                    
                    const codiciData = XLSX.utils.sheet_to_json(codiciSheet, { header: 1 });
                    
                    const nomiPersone = codiciData
                        .filter(row => row[1] && row[2]) // COGNOME e NOME
                        .map(row => `${row[0] || ''} ${row[1]} ${row[2]}`.trim());

                    // Carica descrizioni esistenti dal foglio anno corrente
                    const currentYear = new Date().getFullYear();
                    const yearSheet = wb.Sheets[currentYear.toString()];
                    if (yearSheet) {
                        const yearData = XLSX.utils.sheet_to_json(yearSheet);
                        const descrizioniEsistenti = yearData
                            .map(row => row.Descrizione)
                            .filter(d => d && typeof d === 'string');
                        
                        // Combina e rimuovi duplicati
                        const tutteDescrizioni = [...new Set([...nomiPersone, ...descrizioniEsistenti])].sort();
                        setDescrizioni(tutteDescrizioni);
                        localStorage.setItem('descrizioni', JSON.stringify(tutteDescrizioni));
                    } else {
                        const sorted = nomiPersone.sort();
                        setDescrizioni(sorted);
                        localStorage.setItem('descrizioni', JSON.stringify(sorted));
                    }

                    setLoaded(true);
                };

                reader.readAsArrayBuffer(file);
            };

            const handleDescrizioneChange = (value) => {
                setNewMovimento({ ...newMovimento, descrizione: value });
                
                if (value.length > 0) {
                    const filtered = descrizioni.filter(d => 
                        d.toLowerCase().includes(value.toLowerCase())
                    ).slice(0, 10);
                    setFilteredDescrizioni(filtered);
                    setShowSuggestions(true);
                } else {
                    setShowSuggestions(false);
                }
            };

            const selectDescrizione = (desc) => {
                setNewMovimento({ ...newMovimento, descrizione: desc });
                setShowSuggestions(false);
            };

            const addMovimento = () => {
                if (!newMovimento.data || !newMovimento.descrizione || !newMovimento.importo) {
                    alert('Compila tutti i campi');
                    return;
                }

                const importo = parseFloat(newMovimento.importo);
                if (isNaN(importo)) {
                    alert('Importo non valido');
                    return;
                }

                setMovimenti([...movimenti, {
                    data: newMovimento.data,
                    descrizione: newMovimento.descrizione,
                    importo: importo
                }]);

                // Reset form
                setNewMovimento({
                    data: new Date().toISOString().split('T')[0],
                    descrizione: '',
                    importo: ''
                });
            };

            const deleteMovimento = (index) => {
                setMovimenti(movimenti.filter((_, i) => i !== index));
            };

            const downloadCSV = () => {
                if (movimenti.length === 0) {
                    alert('Nessun movimento da esportare');
                    return;
                }

                // Crea CSV con intestazioni
                let csv = 'Data,Descrizione,Importo\n';
                
                movimenti.forEach(mov => {
                    // Escape virgolette nella descrizione
                    const desc = mov.descrizione.replace(/"/g, '""');
                    csv += `${mov.data},"${desc}",${mov.importo}\n`;
                });

                // Download
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const timestamp = new Date().toISOString().split('T')[0];
                a.download = `movimenti_${timestamp}.csv`;
                a.click();
                URL.revokeObjectURL(url);

                alert('CSV scaricato! Ora trasferiscilo sul PC e esegui lo script Python per aggiornare l\'Excel.');
            };

            const resetDescrizioni = () => {
                if (confirm('Vuoi ricaricare le descrizioni dal file Excel?')) {
                    localStorage.removeItem('descrizioni');
                    setDescrizioni([]);
                    setLoaded(false);
                }
            };

            return (
                <div className="min-h-screen pb-20">
                    {/* Header */}
                    <div className="bg-blue-600 text-white p-4 sticky top-0 z-10 shadow-lg">
                        <h1 className="text-xl font-bold">üí∞ Prima Nota Cassa</h1>
                        <p className="text-xs text-blue-100 mt-1">Genera CSV per aggiornamento Excel</p>
                    </div>

                    <div className="p-4 space-y-4">
                        {/* Carica File Excel (solo prima volta) */}
                        {!loaded && (
                            <div className="bg-white rounded-lg shadow-md p-6">
                                <h2 className="text-lg font-semibold mb-3">üìÇ Setup Iniziale</h2>
                                <p className="text-sm text-gray-600 mb-4">
                                    Carica il file Excel per importare le descrizioni. 
                                    Devi farlo solo la prima volta!
                                </p>
                                <input
                                    ref={fileInputRef}
                                    type="file"
                                    accept=".xlsx,.xls"
                                    onChange={loadExcelFile}
                                    className="hidden"
                                />
                                <button
                                    onClick={() => fileInputRef.current?.click()}
                                    className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold active:bg-blue-700"
                                >
                                    Carica File Excel
                                </button>
                            </div>
                        )}

                        {/* Info descrizioni caricate */}
                        {loaded && (
                            <div className="bg-green-50 border border-green-200 rounded-lg p-3">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-sm text-green-800 font-semibold">‚úì Descrizioni caricate</p>
                                        <p className="text-xs text-green-600">{descrizioni.length} voci disponibili</p>
                                    </div>
                                    <button
                                        onClick={resetDescrizioni}
                                        className="text-blue-600 text-sm font-semibold"
                                    >
                                        Ricarica
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Form Inserimento */}
                        {loaded && (
                            <div className="bg-white rounded-lg shadow-md p-4">
                                <h2 className="text-lg font-semibold mb-4">‚ûï Nuovo Movimento</h2>
                                
                                {/* Data */}
                                <div className="mb-4">
                                    <label className="block text-sm font-semibold mb-2">üìÖ Data</label>
                                    <input
                                        type="date"
                                        value={newMovimento.data}
                                        onChange={(e) => setNewMovimento({ ...newMovimento, data: e.target.value })}
                                        className="w-full border border-gray-300 rounded-lg p-3 text-base"
                                    />
                                </div>

                                {/* Descrizione */}
                                <div className="mb-4 relative">
                                    <label className="block text-sm font-semibold mb-2">üìù Descrizione</label>
                                    <input
                                        ref={descrizioneInputRef}
                                        type="text"
                                        value={newMovimento.descrizione}
                                        onChange={(e) => handleDescrizioneChange(e.target.value)}
                                        onFocus={() => {
                                            if (newMovimento.descrizione.length > 0) {
                                                setShowSuggestions(true);
                                            }
                                        }}
                                        onBlur={() => {
                                            setTimeout(() => setShowSuggestions(false), 200);
                                        }}
                                        className="w-full border border-gray-300 rounded-lg p-3 text-base"
                                        placeholder="Inizia a digitare..."
                                    />
                                    
                                    {/* Suggerimenti */}
                                    {showSuggestions && filteredDescrizioni.length > 0 && (
                                        <div className="absolute z-20 w-full bg-white border border-gray-300 rounded-lg mt-1 shadow-lg max-h-60 overflow-y-auto">
                                            {filteredDescrizioni.map((desc, index) => (
                                                <div
                                                    key={index}
                                                    onClick={() => selectDescrizione(desc)}
                                                    className="p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 active:bg-blue-100"
                                                >
                                                    {desc}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                {/* Importo */}
                                <div className="mb-4">
                                    <label className="block text-sm font-semibold mb-2">üí∞ Importo</label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        value={newMovimento.importo}
                                        onChange={(e) => setNewMovimento({ ...newMovimento, importo: e.target.value })}
                                        className="w-full border border-gray-300 rounded-lg p-3 text-base"
                                        placeholder="+100 incasso, -50 pagamento"
                                    />
                                    <p className="text-xs text-gray-500 mt-1">Usa + per incassi, - per pagamenti</p>
                                </div>

                                <button
                                    onClick={addMovimento}
                                    className="w-full bg-green-600 text-white py-3 rounded-lg font-semibold active:bg-green-700"
                                >
                                    Aggiungi Movimento
                                </button>
                            </div>
                        )}

                        {/* Lista Movimenti */}
                        {movimenti.length > 0 && (
                            <div className="bg-white rounded-lg shadow-md p-4">
                                <div className="flex items-center justify-between mb-4">
                                    <h2 className="text-lg font-semibold">üìã Movimenti ({movimenti.length})</h2>
                                    <button
                                        onClick={downloadCSV}
                                        className="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold text-sm active:bg-blue-700"
                                    >
                                        üíæ Scarica CSV
                                    </button>
                                </div>

                                <div className="space-y-2">
                                    {movimenti.map((mov, index) => (
                                        <div key={index} className="border border-gray-200 rounded-lg p-3">
                                            <div className="flex justify-between items-start">
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <span className="text-sm text-gray-600">{mov.data}</span>
                                                        <span className={`font-bold ${mov.importo >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                            {mov.importo >= 0 ? '+' : ''}{mov.importo.toFixed(2)} ‚Ç¨
                                                        </span>
                                                    </div>
                                                    <p className="text-sm text-gray-800">{mov.descrizione}</p>
                                                </div>
                                                <button
                                                    onClick={() => deleteMovimento(index)}
                                                    className="text-red-600 text-xl ml-2"
                                                >
                                                    √ó
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                <div className="mt-4 pt-4 border-t border-gray-200">
                                    <button
                                        onClick={() => {
                                            if (confirm('Cancellare tutti i movimenti?')) {
                                                setMovimenti([]);
                                            }
                                        }}
                                        className="text-red-600 text-sm font-semibold"
                                    >
                                        üóëÔ∏è Cancella tutti
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Istruzioni */}
                        {loaded && movimenti.length === 0 && (
                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h3 className="font-semibold text-blue-900 mb-2">‚ÑπÔ∏è Come funziona</h3>
                                <ol className="text-sm text-blue-800 space-y-1 list-decimal list-inside">
                                    <li>Inserisci i movimenti usando il form sopra</li>
                                    <li>Quando hai finito, premi "Scarica CSV"</li>
                                    <li>Trasferisci il file CSV sul PC (email, AirDrop, Dropbox)</li>
                                    <li>Esegui lo script Python sul PC per aggiornare l'Excel</li>
                                    <li>Ricarica l'Excel aggiornato su Dropbox</li>
                                </ol>
                            </div>
                        )}

                        {/* Istruzioni CSV scaricato */}
                        {movimenti.length > 0 && (
                            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <h3 className="font-semibold text-yellow-900 mb-2">üìã Prossimi passi</h3>
                                <ol className="text-sm text-yellow-800 space-y-1 list-decimal list-inside">
                                    <li>Scarica il CSV premendo il pulsante sopra</li>
                                    <li>Trasferiscilo sul PC (AirDrop, email, Dropbox)</li>
                                    <li>Metti il CSV nella stessa cartella dell'Excel</li>
                                    <li>Esegui: <code className="bg-yellow-100 px-1 rounded">python aggiorna_cassa.py</code></li>
                                </ol>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));

        // Service Worker per PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register(
                'data:text/javascript;base64,' + btoa(`
                    self.addEventListener('install', (e) => {
                        e.waitUntil(caches.open('pwa-cache').then(cache => {
                            return cache.addAll(['/']);
                        }));
                    });
                    self.addEventListener('fetch', (e) => {
                        e.respondWith(
                            caches.match(e.request).then(response => {
                                return response || fetch(e.request);
                            })
                        );
                    });
                `)
            );
        }
    </script>
</body>
</html>
